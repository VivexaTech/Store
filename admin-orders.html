<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Orders - Vivexa Store</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .toast { position: fixed; bottom: 1.5rem; right: 1.5rem; background-color: #22c55e; color: white; padding: 0.75rem 1.25rem; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); opacity: 0; transform: translateY(20px); transition: all 0.3s ease-in-out; z-index: 1000; }
        .toast.show { opacity: 1; transform: translateY(0); }
    </style>
</head>
<body class="bg-gray-100">

    <header class="bg-white shadow-md">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">Manage Orders</h1>
            <div>
                <a href="admin.html" class="text-indigo-600 hover:underline font-semibold">Back to Dashboard</a>
            </div>
        </nav>
    </header>

    <main class="container mx-auto p-6 my-10">
        <div id="orders-container" class="space-y-8">
            <!-- Orders will be loaded here -->
        </div>
    </main>
    
    <div id="toast-notification" class="toast"></div>

<!-- This file must contain your Firebase config object -->
<script src="create-config.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const ownerEmail = "vivexatech@gmail.com";
        
        if (typeof firebaseConfig === 'undefined') {
            console.error("Firebase config is not loaded. Make sure create-config.js is correct.");
            alert("Firebase configuration is missing. The app cannot start.");
            return;
        }

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const ordersContainer = document.getElementById('orders-container');
        
        // --- SOUND NOTIFICATION SETUP (FIXED) ---
        const notificationSound = new Audio('https://cdn.pixabay.com/audio/2022/03/15/audio_2c28c3a5a8.mp3'); // Using a reliable sound URL
        let canPlaySound = false;
        // Sound can only play after the user clicks anywhere on the page first.
        document.body.addEventListener('click', () => {
            canPlaySound = true;
        }, { once: true }); // This listener runs only once.

        // --- AUTHENTICATION CHECK ---
        auth.onAuthStateChanged(user => {
            if (user && user.email === ownerEmail) {
                loadAndListenForOrders();
                setupPushNotifications(user.uid);
            } else {
                alert("Access Denied. You are not authorized to view this page.");
                window.location.href = 'index.html';
            }
        });

        // --- PUSH NOTIFICATION SETUP ---
        // In your manage orders HTML file

function setupPushNotifications(userId) {
    const messaging = firebase.messaging();
    // The VAPID key you copied from the Firebase console
    const vapidKey = 'YOUR_GENERATED_VAPID_KEY_PASTE_IT_HERE';

    messaging.requestPermission()
        .then(() => messaging.getToken({ vapidKey: vapidKey })) // <-- CHANGE IS HERE
        .then(token => {
            if (token) {
                console.log('FCM Token:', token);
                db.collection('admins').doc(userId).set({ fcmToken: token, email: ownerEmail }, { merge: true });
            }
        })
        .catch(err => console.error('Notification setup failed.', err));
}
        
        // --- REAL-TIME ORDER LISTENER (FIXED) ---
        function loadAndListenForOrders() {
            let isInitialLoad = true;

            db.collection("orders").orderBy("date", "desc")
              .onSnapshot((snapshot) => {
                
                if (isInitialLoad && snapshot.empty) {
                     ordersContainer.innerHTML = '<p class="text-center text-gray-500 text-lg">There are no orders to display yet.</p>';
                }

                // FIX: Clear the "no orders" message BEFORE the loop starts
                if (isInitialLoad && !snapshot.empty && ordersContainer.querySelector('p')) {
                    ordersContainer.innerHTML = '';
                }
                
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        const orderCard = createOrderCard(change.doc);
                        
                        if (isInitialLoad) {
                            ordersContainer.appendChild(orderCard);
                        } else {
                            ordersContainer.prepend(orderCard);
                            showToast("ðŸ”” New Order Received!");
                            // FIX: Play sound for new orders if permission is granted
                            if (canPlaySound) {
                                notificationSound.play().catch(e => console.error("Sound play failed:", e));
                            }
                        }
                    }
                    if (change.type === "modified") {
                        console.log("Order updated: ", change.doc.data());
                        // To update in real-time, find the old card and replace it
                        const updatedCard = createOrderCard(change.doc);
                        const oldCard = document.getElementById(change.doc.id);
                        if(oldCard) {
                            oldCard.replaceWith(updatedCard);
                        }
                    }
                });

                isInitialLoad = false;

              }, (error) => {
                  console.error("Error listening for orders: ", error);
                  ordersContainer.innerHTML = '<p class="text-center text-red-500 text-lg">Error loading orders.</p>';
              });
        }

        // --- DYNAMICALLY CREATE ORDER CARD HTML ---
        function createOrderCard(doc) {
            const order = doc.data();
            const orderCard = document.createElement('div');
            orderCard.className = 'bg-white p-6 rounded-lg shadow-md';
            orderCard.id = doc.id;

            const productsHtml = order.items.map(item => `
                <div class="flex items-center gap-4 py-3 border-b last:border-b-0">
                    <img src="${item.image}" alt="${item.name}" class="w-16 h-16 object-cover rounded-md" onerror="this.src='https://placehold.co/64x64/e2e8f0/94a3b8?text=Image'">
                    <div>
                        <p class="font-semibold">${item.name}</p>
                        <p class="text-sm text-gray-600">Size: ${item.size || 'N/A'} | Color: ${item.color || 'N/A'}</p>
                        <p class="text-sm text-gray-600">Qty: ${item.quantity} | Price: â‚¹${parseFloat(item.price).toFixed(2)}</p>
                    </div>
                </div>
            `).join('');

            const statusOptions = ["Placed", "Shipped", "Out for Delivery", "Delivered", "Cancelled"];
            const statusDropdown = `
                <select class="status-select mt-1 p-2 block w-full border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" data-id="${doc.id}">
                    ${statusOptions.map(status => `<option value="${status}" ${order.status === status ? 'selected' : ''}>${status}</option>`).join('')}
                </select>
            `;

            orderCard.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 border-b pb-4 mb-4">
                    <div>
                        <h3 class="text-sm font-semibold text-gray-500 uppercase">Order Number</h3>
                        <p class="text-lg font-bold text-indigo-600">${order.orderNumber}</p>
                    </div>
                    <div>
                        <h3 class="text-sm font-semibold text-gray-500 uppercase">Order Date</h3>
                        <p class="text-lg font-bold">${new Date(order.date).toLocaleString()}</p>
                    </div>
                    <div>
                        <h3 class="text-sm font-semibold text-gray-500 uppercase">Total Amount</h3>
                        <p class="text-lg font-bold text-gray-800">${order.summary.total}</p>
                    </div>
                     <div>
                        <h3 class="text-sm font-semibold text-gray-500 uppercase">Update Status</h3>
                        ${statusDropdown}
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-xl font-bold mb-4 border-b pb-2">Customer Details</h3>
                        <div class="space-y-2 text-gray-700">
                            <p><strong>Name:</strong> ${order.shippingInfo.fullName}</p>
                            <p><strong>Email:</strong> ${order.shippingInfo.email}</p>
                            <p><strong>Phone:</strong> ${order.shippingInfo.phone}</p>
                            <p><strong>Address:</strong> ${order.shippingInfo.address}, ${order.shippingInfo.city}, ${order.shippingInfo.zip}</p>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold mb-4 border-b pb-2">Ordered Products</h3>
                        <div class="space-y-2">${productsHtml}</div>
                    </div>
                </div>
            `;
            return orderCard;
        }

        // --- HANDLE ORDER STATUS UPDATES ---
        ordersContainer.addEventListener('change', (e) => {
            if (e.target.classList.contains('status-select')) {
                const docId = e.target.dataset.id;
                const newStatus = e.target.value;
                
                db.collection("orders").doc(docId).update({ status: newStatus })
                    .then(() => showToast(`Order status updated to ${newStatus}`))
                    .catch((error) => {
                        console.error("Error updating status: ", error);
                        alert("Failed to update status.");
                    });
            }
        });

        // --- TOAST NOTIFICATION UTILITY ---
        function showToast(message) {
            const toast = document.getElementById('toast-notification');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    });
</script>
</body>
</html>

